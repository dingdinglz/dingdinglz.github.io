<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="什么是etcd，怎么将etcd集成到应用中"><title>etcd的功能与应用</title>
<link rel=canonical href=https://dingdinglz.github.io/p/etcd%E7%9A%84%E5%8A%9F%E8%83%BD%E4%B8%8E%E5%BA%94%E7%94%A8/><link rel=stylesheet href=/scss/style.min.81579ea678e30582aa60028bfe3192821d6c0fee666ee279be318fb5b558916b.css><meta property='og:title' content="etcd的功能与应用"><meta property='og:description' content="什么是etcd，怎么将etcd集成到应用中"><meta property='og:url' content='https://dingdinglz.github.io/p/etcd%E7%9A%84%E5%8A%9F%E8%83%BD%E4%B8%8E%E5%BA%94%E7%94%A8/'><meta property='og:site_name' content="Dinglz 's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='golang'><meta property='article:tag' content='etcd'><meta property='article:published_time' content='2025-03-24T02:00:00+00:00'><meta property='article:modified_time' content='2025-03-24T02:00:00+00:00'><meta name=twitter:title content="etcd的功能与应用"><meta name=twitter:description content="什么是etcd，怎么将etcd集成到应用中"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu9713755695089526605.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Dinglz 's Blog</a></h1><h2 class=site-description>keep learning...</h2></div></header><ol class=menu-social><li><a href=https://github.com/dingdinglz target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>分类</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#什么是etcd>什么是etcd</a></li><li><a href=#etcd的实际应用>etcd的实际应用</a><ol><li><a href=#前置工作>前置工作</a></li></ol></li><li><a href=#部署>部署</a></li><li><a href=#golang连接etcd>Golang连接etcd</a></li><li><a href=#键值对的读和写>键值对的读和写</a><ol><li><a href=#写>写</a></li><li><a href=#读>读</a></li><li><a href=#按前缀读>按前缀读</a></li></ol></li><li><a href=#键值对的合租lease>键值对的合租（lease）</a><ol><li><a href=#设置过期时间>设置过期时间</a></li><li><a href=#服务器维护心跳包>服务器维护心跳包</a></li></ol></li><li><a href=#监听键值对watch>监听键值对（watch）</a></li><li><a href=#分布式锁>分布式锁</a><ol><li><a href=#分布式锁的原理>分布式锁的原理</a></li><li><a href=#实现>实现</a></li></ol></li><li><a href=#服务发现与治理>服务发现与治理</a></li><li><a href=#etcd与redis的异同>etcd与redis的异同</a></li><li><a href=#写在最后>写在最后</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#c71585;color:#fff>Go
</a><a href=/categories/github/ style=background-color:#ee9a00;color:#fff>Github项目分享</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/etcd%E7%9A%84%E5%8A%9F%E8%83%BD%E4%B8%8E%E5%BA%94%E7%94%A8/>etcd的功能与应用</a></h2><h3 class=article-subtitle>什么是etcd，怎么将etcd集成到应用中</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-03-24T02:00:00Z>Mar 24, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><blockquote><p>伟大的etcd构成了云原生的基石</p></blockquote><h2 id=什么是etcd>什么是etcd</h2><p>etcd 是由 CoreOS（现为 Red Hat 旗下）开发的分布式键值存储系统，采用 Go 语言编写。它通过 Raft 共识算法实现高可用性，专为分布式系统设计，提供以下核心能力：</p><ul><li><p><strong>强一致性</strong>：保证所有节点数据状态完全一致</p></li><li><p><strong>高可用性</strong>：通过多节点集群自动故障转移</p></li><li><p><strong>简单易用</strong>：通过 HTTP API 提供 RESTful 接口</p></li><li><p><strong>可扩展性</strong>：支持水平扩展和动态集群管理</p></li></ul><p>在分布式系统领域，etcd 以其优雅的设计和强大的功能，成为云原生时代的基础设施基石。它就像一个"分布式系统的心脏"，为 Kubernetes、Service Mesh 等系统提供核心的分布式数据管理能力。</p><h2 id=etcd的实际应用>etcd的实际应用</h2><ul><li><p>为分布式系统提供配置设置中心，也就是键值对存储，有点类似于redis，下面我们会谈到它和redis的异同</p></li><li><p>实现配置的热更新，也就是利用etcd的watch功能监听键值的变化</p></li><li><p>作为分布式锁的一种实现形式</p></li><li><p>作为微服务中，服务发现与注册中心（得益于lease和watch）</p></li></ul><p>下面，我们将针对这些实际应用，将golang代码实现结合来进行讲解</p><p>在此之前，先完成前置准备工作：</p><h3 id=前置工作>前置工作</h3><ol><li><p>安装etcd：<a class=link href=https://etcd.io/docs/v3.5/install/ target=_blank rel=noopener>Install | etcd</a></p></li><li><p>本文go实现代码基于ectd官方client包：<a class=link href=https://github.com/etcd-io/etcd/tree/main/client/v3 target=_blank rel=noopener>etcd/client/v3 at main · etcd-io/etcd · GitHub</a></p></li></ol><p>Let&rsquo;s start</p><h2 id=部署>部署</h2><p>etcd支持单机部署和集群式部署，集群式部署时，etcd保证了自己不同终端间的数据高度一致性和高度可用性，也就是说，与redis相比，etcd更加一致，同步速度更快，因而作为分布式配置同步是很好的选择</p><p>由于本文主要谈一谈etcd能帮我们实现哪些内容，就不在此详细说明如何部署etcd集群（让运维哥去头疼吧哈哈哈），想要了解详细内容可以参考：<a class=link href=https://etcd.io/docs/v3.5/tutorials/how-to-setup-cluster/ target=_blank rel=noopener>How to Set Up a Demo etcd Cluster | etcd</a></p><h2 id=golang连接etcd>Golang连接etcd</h2><p>首先安装前置工作中的etcd官方的client包，然后参考下述代码进行连接，即可得到一个etcd的client对象</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>etcd</span> <span class=s>&#34;go.etcd.io/etcd/client/v3&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>etcd</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>etcd</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Endpoints</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;localhost:2379&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=键值对的读和写>键值对的读和写</h2><p>etcd最基础的功能其实就是做一个kv存储，有点类似于redis，但是etcd并不具备redis那样丰富的数据类型，所以存储和读取时的结构只有string-string。更多拓展可以考虑用json格式去封装</p><h3 id=写>写</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>client</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>,</span> <span class=s>&#34;test-value&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这样即给test设置了值</p><h3 id=读>读</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>res</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>res</span><span class=p>.</span><span class=nx>Kvs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Value</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这样即可以取到key和value</p><p>大家可能有疑惑为什么res.Kvs是一个切片而不是一个元素，因为Get可以按前缀读</p><h3 id=按前缀读>按前缀读</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>res</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>,</span> <span class=nx>etcd</span><span class=p>.</span><span class=nf>WithPrefix</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>e</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>res</span><span class=p>.</span><span class=nx>Kvs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34;:&#34;</span> <span class=o>+</span> <span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Value</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到区别仅仅在于<code>etcd.WithPrefix()</code>，这句的意思就是读所有前缀是test的键值对，有点类似于test*，我们如果新建一个test2和test3，用上述代码可以全部读出来</p><h2 id=键值对的合租lease>键值对的合租（lease）</h2><p>所谓lease，可以理解成一个键的保质期，lease用于与键进行绑定，一个lease可以绑定多个键，当lease过期时，对应的键都会被删除。</p><p>与正常的过期时间不同的是，lease可以被续时或者直接销毁。</p><p>基于以上特点，让我们想想lease可以拿来做什么：</p><ul><li><p>配合监听机制去做心跳包，也就是设置一个过期时间，让服务器端不断的去维护（延时）lease，如果服务器宕机了，与lease绑定的键会自动删除，也就说明了这台服务器对应的已经不可用</p></li><li><p>根据上面那点可以继续拓展，做微服务的服务注册，比如一个api对应一个ip，让服务器动态维护ip的更新，服务器寄了也就导致这个api失效</p></li></ul><h3 id=设置过期时间>设置过期时间</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 创建一个新的lease，过期时间是5s
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>lease</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Grant</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 将刚刚创建的lease与键绑定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>client</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>,</span> <span class=s>&#34;test-lease&#34;</span><span class=p>,</span> <span class=nx>etcd</span><span class=p>.</span><span class=nf>WithLease</span><span class=p>(</span><span class=nx>lease</span><span class=p>.</span><span class=nx>ID</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>大家可以试一下5s后再去取test这个键，这个时候test已经被删除</p><h3 id=服务器维护心跳包>服务器维护心跳包</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 创建一个新的lease，过期时间是5s
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>lease</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Grant</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 将刚刚创建的lease与键绑定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>client</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;heart-ping&#34;</span><span class=p>,</span> <span class=s>&#34;live&#34;</span><span class=p>,</span> <span class=nx>etcd</span><span class=p>.</span><span class=nf>WithLease</span><span class=p>(</span><span class=nx>lease</span><span class=p>.</span><span class=nx>ID</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 留1s给网络因素
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>4</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span><span class=p>.</span><span class=nf>KeepAliveOnce</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>lease</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，验证服务器是否存活只需要验证heart-ping是否存在即可</p><h2 id=监听键值对watch>监听键值对（watch）</h2><p>实时监听键值对的变化，根据这个功能可以做到配置的热更新等等</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 监听test键
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>watcher</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Watch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>event</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>watcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Events</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>item</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>etcd</span><span class=p>.</span><span class=nx>EventTypeDelete</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34; deleted&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34; changed:&#34;</span> <span class=o>+</span> <span class=nb>string</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Kv</span><span class=p>.</span><span class=nx>Value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>类似的，watch也接受<code>etcd.WithPrefix()</code>参数</p><h2 id=分布式锁>分布式锁</h2><p>既然redis可以维护一个分布式锁，那么我etcd当然也行，并且同步性更强，更易于拓展</p><h3 id=分布式锁的原理>分布式锁的原理</h3><p>通过redis、etcd这些中间件，让一把锁可以被多个应用共用，实现原理也很简单，维护一个键的存在作为锁被占用，不存在作为未加锁的状态去实现，例如使用redis的<code>SETNX</code></p><p>分布式锁想要实现的功能与本地的<code>sync.MXLock</code>这些基本类似，区别仅仅在于前者允许多个系统同时访问</p><h3 id=实现>实现</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 开启一个事务
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>res</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Txn</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>If</span><span class=p>(</span><span class=nx>etcd</span><span class=p>.</span><span class=nf>Compare</span><span class=p>(</span><span class=nx>etcd</span><span class=p>.</span><span class=nf>CreateRevision</span><span class=p>(</span><span class=s>&#34;lock&#34;</span><span class=p>),</span> <span class=s>&#34;=&#34;</span><span class=p>,</span> <span class=s>&#34;0&#34;</span><span class=p>)).</span> <span class=c1>// 如果lock不存在，即为可以加锁
</span></span></span><span class=line><span class=cl><span class=c1></span>											<span class=nf>Then</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>etcd</span><span class=p>.</span><span class=nf>OpPut</span><span class=p>(</span><span class=s>&#34;lock&#34;</span><span class=p>,</span> <span class=s>&#34;1&#34;</span><span class=p>),</span> <span class=c1>// 创建lock占用锁
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>).</span>
</span></span><span class=line><span class=cl>	<span class=nf>Commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>res</span><span class=p>.</span><span class=nx>Succeeded</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 加锁成功
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// do someting ....
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 解锁
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;lock&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;加锁失败，占用中&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了不形成死锁，也就是一直保持占用状态，可以通过设置ctx的timeout或者用刚刚说的lease去维护一个过期时间来处理</p><p>加锁失败的情况也不代表彻底不能使用，只是当前被占用，可以用循环尝试多次上锁等等操作</p><h2 id=服务发现与治理>服务发现与治理</h2><p>比如说，一个rpc服务，有个function，调用的ip地址有多个，通过心跳包实时维护他的地址，通过watch去动态更新调用的地址，如果你想要深入了解这方面，可以去阅读go-zero的相关部分的源码，它的默认实现就是利用etcd</p><h2 id=etcd与redis的异同>etcd与redis的异同</h2><div class=table-wrapper><table><thead><tr><th><strong>特性</strong></th><th><strong>Redis</strong></th><th><strong>etcd</strong></th></tr></thead><tbody><tr><td><strong>核心功能</strong></td><td>高性能键值存储系统，支持多种数据结构（字符串、列表、哈希、集合、有序集合等）。</td><td>分布式一致性键值存储系统，专注于服务发现、配置管理、分布式协调。</td></tr><tr><td><strong>数据模型</strong></td><td>支持丰富的数据类型，如字符串、列表、哈希、集合、有序集合、位图、地理空间等。</td><td>仅支持简单的键值对（字符串），但支持版本控制、租约（Lease）和目录结构（递归操作）。</td></tr><tr><td><strong>一致性模型</strong></td><td>支持最终一致性（异步复制）或强一致性（通过 Redis Cluster 或多主模式）。</td><td>通过 Raft 协议保证强一致性，所有节点数据实时同步。</td></tr><tr><td><strong>性能</strong></td><td>高吞吐量和低延迟，适合高频读写操作（如缓存、队列）。</td><td>为一致性牺牲部分性能，但能满足分布式系统协调需求。</td></tr><tr><td><strong>持久化</strong></td><td>支持 RDB（快照）和 AOF（追加日志）两种持久化方式。</td><td>数据持久化基于 Raft 日志，支持 WAL（预写日志）和快照。</td></tr><tr><td><strong>适用场景</strong></td><td>缓存、队列、实时计数器、会话管理、消息中间件（如 Redis Pub/Sub）。</td><td>服务发现、配置中心、分布式锁、 leader 选举、分布式状态协调（如 Kubernetes）。</td></tr><tr><td><strong>一致性协议</strong></td><td>不依赖特定协议，通过主从复制或 Cluster 实现分布式。</td><td>基于 Raft 协议实现分布式一致性，确保所有节点数据一致。</td></tr><tr><td><strong>集群管理</strong></td><td>需要额外工具（如 Redis Cluster、Redis Sentinel）实现高可用。</td><td>内置集群管理，自动故障转移和节点发现。</td></tr><tr><td><strong>API 接口</strong></td><td>原生协议（Redis Protocol）或 RESTful API（通过 RedisJSON 等模块扩展）。</td><td>原生 HTTP/JSON API，支持 Watch 机制（实时监听键值变化）。</td></tr><tr><td><strong>生态系统</strong></td><td>丰富的客户端库（支持多种语言）、插件和扩展模块（如 RedisModule）。</td><td>提供官方客户端库（Go、Java、Python 等），专注于分布式协调场景。</td></tr><tr><td><strong>部署复杂度</strong></td><td>单机部署简单，集群模式需配置主从或 Cluster。</td><td>需要集群部署（至少 3 个节点），但管理相对自动化。</td></tr><tr><td><strong>典型用途示例</strong></td><td>缓存高频访问数据、实现消息队列（如 Celery）、实时计数器（如限流）。</td><td>存储分布式系统的配置、服务注册与发现、协调分布式任务（如 etcd 作为 Kubernetes 的存储后端）。</td></tr></tbody></table></div><h2 id=写在最后>写在最后</h2><p>在咕咕了很久之后终于又更新了一篇（），etcd在目前谈啥都要聊聊分布式的年代（虽然或许其实不需要用分布式也能带得动呢，真的有那么多用户吗？）起着很重要的作用，etcd在这个领域也不是一家独大，它的“同行”有zookeeper等等，但显然etcd是其中格外出色的。</p><p>顺便一提，最近有种很忙又不知道在忙啥的感觉（），希望下次更新可以提上日程吧，尚且咕咕了一篇kmp和eino的内容，唉唉唉</p></section><footer class=article-footer><section class=article-tags><a href=/tags/golang/>Golang</a>
<a href=/tags/etcd/>Etcd</a></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>Last updated on Mar 24, 2025 02:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mcp-with-golang/><div class=article-details><h2 class=article-title>Mcp with golang</h2></div></a></article><article><a href=/p/jwt%E7%9A%84%E5%BA%94%E7%94%A8/><div class=article-details><h2 class=article-title>JWT的应用</h2></div></a></article><article><a href=/p/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E7%BB%98%E5%88%B6mcp%E7%89%88/><div class=article-details><h2 class=article-title>思维导图绘制（mcp版）</h2></div></a></article><article><a href=/p/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-go-1.23-iter-%E5%8C%85/><div class=article-details><h2 class=article-title>深入理解 Go 1.23 iter 包</h2></div></a></article><article><a href=/p/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%AB%98%E6%95%88%E7%9A%84%E7%BD%91%E7%AB%99%E5%90%8E%E7%AB%AF%E5%BA%94%E7%94%A8/><div class=article-details><h2 class=article-title>如何构建一个高效的网站后端应用</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 Dinglz 's Blog</section><section class=powerby>copyright &copy; dinglz<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>